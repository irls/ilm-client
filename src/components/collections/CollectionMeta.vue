<template>
  <div>
    <fieldset>
      <legend>Collection Metadata</legend>
      <table class="properties">
        <tr>
          <td>
            Collection ID
          </td>
          <td>
            {{collection._id}}
          </td>
        </tr>
        <tr>
          <td>
            Title
          </td>
          <td>
            <input v-model="collection.title" v-on:change="update('title', $event)" :disabled="!allowCollectionsEdit" />
          </td>
        </tr>
        <tr>
          <td>
            Subtitle
          </td>
          <td>
            <input v-model="collection.subtitle" v-on:change="update('subtitle', $event)" :disabled="!allowCollectionsEdit" />
          </td>
        </tr>
        <tr class="author">
          <td>
            Author
          </td>
          <td>
            <div class="authors">
              <div class="author-row" v-if="collection.author && collection.author.length === 0">
                <input v-model="collection.author[0]" 
                  v-on:change="update('author', $event)" 
                  :disabled="!allowCollectionsEdit"
                  >
                <div class="dropdown" v-if="collection.author && collection.author.length === 0">
                  <div v-on:click="toggleShowUnknownAuthor()" 
                    class="dropdown-button" >
                    <i class="fa fa-angle-down" ></i>
                  </div>
                  <div class="dropdown-content" 
                    v-if="showUnknownAuthor && allowCollectionsEdit" 
                    v-on:click="setUnknownAuthor()" >Unknown</div>
                </div>
              </div>
              <template v-for="(author, i) in collection.author" >
                <div class="author-row">
                  <input v-model='collection.author[i]' v-on:change="update('author', $event); " :disabled="!allowCollectionsEdit">
                  <div class="dropdown" v-if=" i == 0">
                    <div v-on:click="toggleShowUnknownAuthor()" class="dropdown-button">
                      <i class="fa fa-angle-down" ></i>
                    </div>
                    <div class="dropdown-content" v-if="showUnknownAuthor && allowCollectionsEdit" 
                      v-on:click="setUnknownAuthor()" >Unknown</div>
                  </div>
                  <button v-if="i !== 0" v-on:click="removeAuthor(i)" :class="[{'disabled': i == 0 && collection.author.length == 1}, 'remove-author']">
                    <i class="fa fa-minus-circle" v-if="allowCollectionsEdit"></i>
                  </button>
                </div>
              </template>
              <button v-on:click="addAuthor" class="add-author" v-if="allowCollectionsEdit">
                <i class="fa fa-plus-circle"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            Language
          </td>
          <td>
            <select class="form-control" v-model="collection.language" 
              v-on:change="update('language', $event)"
              :disabled="!allowCollectionsEdit" >
              <option v-for="(value, key) in languages" :value="key">{{ value }}</option>
            </select>
          </td>
        </tr>
      </table>
    </fieldset>
    <fieldset>
      <legend>URL slug</legend>
      <input v-model="collection.slug" class="collection-slug" :disabled="!allowCollectionsEdit" />
    </fieldset>
    <fieldset>
      <table class="properties">
        <tr>
          <td>
            Category
          </td>
          <td>
            <select  class="form-control" v-model="collection.category" v-on:change="update('category', $event)" :disabled="!allowCollectionsEdit">
              <template v-for="(data, index) in bookCategories">
                <optgroup :label="data.group">
                  <option v-for="(value, ind) in data.categories" :value="value">{{ value }}</option>
                </optgroup>
              </template>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            Difficulty
          </td>
          <td>
            <input type="number" min="1" max="14.99" step="0.01" v-model="collection.difficulty" v-on:change="update('difficulty', $event)" :disabled="!allowCollectionsEdit" />
          </td>
        </tr>
        <tr>
          <td>
            Translator
          </td>
          <td>
            <input v-model="collection.translator" v-on:change="update('translator', $event)" :disabled="!allowCollectionsEdit" />
          </td>
        </tr>
        <tr>
          <td>
            Weight
          </td>
          <td>
            <input type="number" min="1" max="10.99" step="0.01" v-model="collection.weight" v-on:change="update('weight', $event)" :disabled="!allowCollectionsEdit" />
          </td>
        </tr>
      </table>
    </fieldset>
    <fieldset>
      <div class="coverimg" v-on:click="changeCoverModal()">
        <img height="80" v-if="collectionImage" v-bind:src="collectionImage" />
        <div v-else class="coverimg-wrap"></div>
      </div>
      <button class="btn btn-primary edit-coverimg" v-on:click="changeCoverModal()" v-if="allowCollectionsEdit">
        <i class="fa fa-pencil" ></i>
      </button>
    </fieldset>
    <fieldset>
      <legend>Description</legend>
        <textarea v-model="collection.description" class="collection-description" v-on:change="update('description', $event)" :disabled="!allowCollectionsEdit"></textarea>
    </fieldset>
    <div class="collection-meta col-sm-12">
      <CollectionCoverModal ref="collectionCoverModal" @closed="resetCollectionImage"></CollectionCoverModal>
    </div>
  </div>
</template>
<script>
  import _ from 'lodash';
  import superlogin from 'superlogin-client';
  import PouchDB from 'pouchdb';
  import {mapActions, mapGetters} from 'vuex';
  import api_config from '../../mixins/api_config';
  import { Languages }      from "../../mixins/lang_config.js"
  import CollectionCoverModal from './CollectionCoverModal';
  export default {
      name: 'CollectionMeta',
      data() {
        return {
          'collection': {},
          showCollectionCoverModal: false,
          collectionImage: '',
          showUnknownAuthor: false,
          showUnknownAuthorEn: false,
        }
      },
      components: {
        'CollectionCoverModal': CollectionCoverModal
      },
      mounted() {
        this.init();
      },
      mixins: [api_config],
      methods: {
        init() {
          if (this.currentCollection) {
            this.collection = Object.assign({}, this.currentCollection);
          } else {
            this.collection = {};
          }
          this.resetCollectionImage();
        },
        update(key, event) {
          let value = key === 'author' ? this.currentCollection.author : event.target.value;
          this.liveUpdate(key, value);
        },
        change(field) {
          this.liveUpdate(field, this.collection[field]);
        },
        liveUpdate(field, value) {
          if (!this.allowCollectionsEdit) {
            return false;
          }
          let update = {};
          update[field] = value;
          return this.updateCollection(update)
            .then(() => {
              this.collection[field] = value;
            });
        },
        publish() {
          let api_url = this.API_URL + 'collection/' + this.currentCollection._id + '/publish';
          let api = this.$store.state.auth.getHttp();
          let self = this;
          api.post(api_url, {}, {}).then(function(response){
            self.reloadCollection();
          }).catch((err) => {

          });
        },
        changeCoverModal() {
          if (!this.allowCollectionsEdit) {
            return false;
          }
          this.$refs.collectionCoverModal.show();
        },
        resetCollectionImage() {
          this.collectionImage = '';
          if (this.currentCollection.coverimgURL) {
            this.collectionImage = this.currentCollection.coverimgURL + '?' + Date.now();
          }
        },
        toggleShowUnknownAuthor(setValue = null) {
          if (setValue === null) {
            this.showUnknownAuthor = !this.showUnknownAuthor;
          } else {
            this.showUnknownAuthor = setValue ? true : false;
          }
        },
        addAuthor() {
          this.collection.author.push('');
          this.liveUpdate('author', this.collection.author);
        },
        removeAuthor(i) {
          if (i > 0 || this.collection.author.length > 1) {
            this.collection.author.splice(i, 1);
            this.liveUpdate('author', this.collection.author);
          }
        },
        setUnknownAuthor() {
          this.toggleShowUnknownAuthor(false);
          this.collection.author[0] = 'Unknown';
          this.liveUpdate('author', this.collection.author);
        },
        ...mapActions(['reloadCollection', 'updateCollectionVersion', 'updateCollection'])
      },
      computed: {
        collectionBooksLength: {
          get() {
            return this.collection.books ? this.collection.books.length : 0;
          }
        },
        hasTitleWarning: {
          get() {
            return this.allowCollectionsEdit && (!this.collection.title || this.collection.title.length == 0);
          }
        },
        languages() {
          return Languages;
        },

        ...mapGetters(['currentCollection', 'allowCollectionsEdit', 'allowPublishCurrentCollection', 'bookCategories'])
      },
      watch: {
        'currentCollection': {
          handler(val, oldVal) {
            
            this.init();
          },
          deep: true
        }
      }
  }
</script>
<style scoped src='../books/css/BookProperties.css'></style>
<style lang="less">
  .collection-meta {
    /*position: fixed;
    width: 29%;*/
    height: 100%;
    overflow-y: auto;
    /*padding-top: 38px;*/
    fieldset {
      border:1px solid #b9b6b6;
      position:relative;
      margin-bottom:10px;
    }
    legend {
      width:auto;
      border-bottom:0;
      font-size:12px;
      margin-bottom:0;
    }
    textarea {
      width: 100%;
      border: none;
      resize: none;
      height: 100px;
    }
    .has-error {
      border: solid 1px red;
    }
    .error-message {
      margin: 0px;
    }
  }
  .collection-meta::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
    border-radius: 10px;
    background-color: #F5F5F5;
  }
  .collection-meta::-webkit-scrollbar {
    width: 12px;
    background-color: #F5F5F5;
  }
  .collection-meta::-webkit-scrollbar-thumb {
    border-radius: 10px;
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
    background-color: #555;
  }
  
  /* Properties editor area */
  table.properties {
    margin:0; 
    padding:0; 
    width:100%; 
    font-size: 1em;
    border-collapse: separate; 
    border-spacing: 3px;
    td {
      &:nth-child(1) {
        width: 30%; 
        padding: 3px; 
        margin:0;
      }
      &:nth-child(2) {
        width: auto; 
        text-align: right !important;
      }
    }
    tr{
      &:nth-child(odd) {
        background-color: #F0F0F0;
      }
      &.author {
        .authors {
          display: table;
          width: 100%;
          .dropdown {
            padding: 0px 2px;
            width: 10%;
          }
          .author-row {
            display: table-row;
            input {
              display: table-cell;
              width: 90%;
            }
            .remove-author {
              display: table-cell;
              background: transparent;
              border: none;
              width: 10%;
            }
          }
          .add-author {
            background: transparent;
            border: none;
            width: 27px;
          }
          .dropdown-content {
            text-align: center;
          }
        }
      }
    }
  }
  
  table tr {border: 2px solid white}
  table tr.changed {border: 2px solid wheat}
  table tr input {font-size: 1em; width: 100%}
  .collection-slug {
    width: 100%;
  }
  .coverimg {
    padding:0; margin: 5px; margin-right: 8px;
    float: right;
    margin-left: 3px;
    margin-top: 10px;
    background: white;
    box-shadow: inset 0px 0px 3px 3px rgba(0,0,0,0.06);
    cursor: pointer;
    position: relative;
    .coverimg-wrap {
      height: 80px;
      width: 60px;
    }
  }
  .edit-coverimg {
    float: right;
    margin-top: 10px;
    i {
      color: white;
    }
  }
  .collection-description {
    width: 100%;
  }
</style>
